{% extends 'base.html' %}

{% block title %}Propiedades - RentalSys{% endblock %}
{% block header_title %}Propiedades{% endblock %}

{% block content %}
<!-- CONTENEDOR PRINCIPAL CON ALTURA COMPLETA -->
<div class="h-full flex flex-col overflow-hidden">
    <!-- HEADER FIJO -->
    <div class="flex-shrink-0 bg-white dark:bg-gray-900 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-30">
        <!-- T√≠tulo y botones -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 p-6 pb-4">
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4 md:mb-0">üè¢ Gesti√≥n de Propiedades</h2>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
                {% if current_user.is_authenticated and current_user.role in ['admin', 'gestor'] %}
                    <button onclick="showCreatePropertyModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md flex items-center focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                        <i class="fas fa-plus mr-2"></i> Nueva propiedad
                    </button>
                {% endif %}
                <div class="relative">
                    <input type="text" id="propertySearch" placeholder="Buscar propiedades, direcciones, propietarios..." class="form-input pl-10 pr-4 py-2 border border-gray-300 rounded-md w-full focus:border-blue-500 focus:ring-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" onkeyup="searchProperties()">
                    <div class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 dark:text-gray-500">
                        <i class="fas fa-search"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- CONTENEDOR DE TABLA CON SCROLL -->
    <div class="flex-1 overflow-hidden">
        <div class="h-full bg-white dark:bg-gray-800 rounded-lg shadow mx-6 mb-6 overflow-hidden">
            <!-- TABLA CON SCROLL INDEPENDIENTE -->
            <div class="h-full overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                    <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Direcci√≥n</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ciudad</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Ref. Catastral</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">N¬∫ Local</th>
                            <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">M¬≤</th>
                            <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">A√±o Const.</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Propietario</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Estado</th>
                            {% if current_user.is_authenticated and current_user.role in ['admin', 'gestor'] %}
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">Acciones</th>
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody id="propertiesTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                        {% if propiedades %}
                            {% for prop in propiedades %}
                            <tr class="highlight-row property-row hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                data-id="{{ prop.id }}"
                                data-direccion="{{ prop.direccion | e }}"
                                data-ciudad="{{ prop.ciudad | default('', true) | e }}"
                                data-cp="{{ prop.codigo_postal | default('', true) | e }}"
                                data-ref-catastral="{{ prop.referencia_catastral | default('', true) | e }}"
                                data-numero-local="{{ prop.numero_local | default('', true) | e }}"
                                data-superficie="{{ prop.superficie_construida | default('', true) }}"
                                data-ano-construccion="{{ prop.ano_construccion | default('', true) }}"
                                data-tipo="{{ prop.tipo | default('', true) | e }}"
                                data-propietario-id="{{ prop.propietario_id }}"
                                data-propietario-nombre="{{ prop.propietario_ref.nombre if prop.propietario_ref else 'N/A' | e }}"
                                data-descripcion="{{ prop.descripcion | default('', true) | e }}"
                                data-estado="{{ prop.estado_ocupacion | default('vacia', true) }}"
                            >
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-10 w-10 rounded-full bg-purple-100 dark:bg-purple-900/50 flex items-center justify-center">
                                             <i class="fas fa-map-marker-alt text-purple-600 dark:text-purple-400"></i>
                                        </div>
                                        <div class="ml-4">
                                            <div class="text-sm font-medium text-gray-900 dark:text-white">{{ prop.direccion }}</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">{{ prop.codigo_postal | default('') }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ prop.ciudad | default('-') }}</td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ prop.referencia_catastral | default('-') }}</td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ prop.numero_local | default('-') }}</td>
                                <td class="px-3 py-4 whitespace-nowrap text-right">
                                    <div class="text-sm text-gray-500 dark:text-gray-400">
                                        {% if prop.superficie_construida %}
                                            {{ prop.superficie_construida }} m¬≤
                                        {% else %}
                                            -
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-center">
                                    <div class="text-sm text-gray-500 dark:text-gray-400">{{ prop.ano_construccion | default('-') }}</div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ prop.tipo | default('-') }}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">{{ prop.propietario_ref.nombre if prop.propietario_ref else 'N/A' }}</td>
                                <td class="px-4 py-4 whitespace-nowrap">
                                     {% if prop.estado_ocupacion == 'ocupada' %}
                                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-300">Ocupada</span>
                                     {% elif prop.estado_ocupacion == 'vacia' %}
                                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 dark:bg-red-900/50 text-red-800 dark:text-red-300">Vac√≠a</span>
                                     {% elif prop.estado_ocupacion == 'mantenimiento' %}
                                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 dark:bg-yellow-900/50 text-yellow-800 dark:text-yellow-300">Mantenimiento</span>
                                     {% else %}
                                         <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-300">
                                             {{ prop.estado_ocupacion | capitalize }}
                                         </span>
                                     {% endif %}
                                </td>
                                {% if current_user.is_authenticated and current_user.role in ['admin', 'gestor'] %}
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                                        <button onclick="editProperty(this)" class="text-blue-600 hover:text-blue-900 dark:text-blue-400 dark:hover:text-blue-300" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteProperty({{ prop.id }})" class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300" title="Eliminar">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="{{ 10 if current_user.is_authenticated and current_user.role in ['admin', 'gestor'] else 9 }}"
                                    class="px-6 py-8 whitespace-nowrap text-center text-sm text-gray-500 dark:text-gray-400">
                                    <div class="flex flex-col items-center space-y-2">
                                        <i class="fas fa-building text-3xl text-gray-300 dark:text-gray-600"></i>
                                        <p>No hay propiedades registradas.</p>
                                        {% if current_user.is_authenticated and current_user.role in ['admin', 'gestor'] %}
                                            <p class="text-xs">Puedes crear una usando el bot√≥n "Nueva propiedad"</p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- FOOTER DE LA TABLA FIJO -->
            <div class="bg-gray-50 dark:bg-gray-900/50 px-6 py-3 flex items-center justify-between border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
                <div class="text-sm text-gray-700 dark:text-gray-300">
                    Mostrando <span class="font-medium" id="resultsCount">{{ propiedades|length }}</span> de <span class="font-medium" id="totalCount">{{ propiedades|length }}</span> propiedades
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Crear Propiedad -->
<div id="createPropertyModal" class="fixed inset-0 overflow-y-auto hidden z-50" role="dialog" aria-labelledby="create-property-modal-title" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">‚Äã</span>
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl w-full modal-content">
            <form id="createPropertyForm" action="{{ url_for('propiedades_bp.add_propiedad') }}" method="POST" novalidate>
                {{ csrf_form.csrf_token }}
                <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4">
                    <div class="flex items-center justify-between">
                        <h3 id="create-property-modal-title" class="text-xl font-semibold text-white flex items-center">
                            <i class="fas fa-building mr-3"></i> Nueva Propiedad
                        </h3>
                        <button type="button" onclick="closeModal('createPropertyModal')" class="text-white/80 hover:text-white transition-colors focus:outline-none focus:ring-2 focus:ring-white/50 rounded-lg p-1">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                </div>
                <div class="px-6 py-4 max-h-[calc(100vh-200px)] overflow-y-auto modal-body">
                    <div class="space-y-3">
                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800">
                            <h4 class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-2">B√∫squeda en Catastro (Opcional)</h4>
                            <div class="flex items-stretch">
                                <div class="relative flex-1">
                                    <input type="text" id="catastroSearchRef" placeholder="Referencia Catastral (14-20 caracteres)" maxlength="20" class="form-input w-full pl-8 pr-3 py-2 text-sm rounded-l-lg">
                                    <i class="fas fa-search absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                                </div>
                                <button type="button" onclick="fetchCatastroData('property')" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-4 py-2 rounded-r-lg text-sm">
                                    <i class="fas fa-map-marked-alt mr-1"></i><span class="hidden sm:inline">Catastro</span>
                                </button>
                            </div>
                            <div id="catastroLookupStatus" class="text-xs mt-1 min-h-[1.2em]"></div>
                        </div>
                        <div class="relative">
                            <input type="text" id="propertyAddress" name="propertyAddress" required placeholder="Direcci√≥n *" class="form-input w-full pl-8 h-10">
                            <i class="fas fa-map-marker-alt absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <div class="relative sm:col-span-2">
                                <input type="text" id="propertyCity" name="propertyCity" placeholder="Ciudad" class="form-input w-full pl-8 h-10">
                                <i class="fas fa-city absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div class="relative">
                                <input type="text" id="propertyPostalCode" name="propertyPostalCode" placeholder="C.P." class="form-input w-full pl-8 h-10">
                                <i class="fas fa-mail-bulk absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div class="relative">
                                <input type="text" id="propertyRefCatastral" name="propertyRefCatastral" placeholder="Ref. Catastral (Editable)" maxlength="20" class="form-input w-full pl-8 h-10">
                                <i class="fas fa-barcode absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div class="relative">
                                <input type="text" id="propertyNumeroLocal" name="propertyNumeroLocal" placeholder="N¬∫ Local/Piso/Puerta" maxlength="50" class="form-input w-full pl-8 h-10">
                                 <i class="fas fa-door-open absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                             <div class="relative">
                                <input type="number" id="propertySuperficie" name="propertySuperficie" placeholder="Superficie (m¬≤)" min="0" class="form-input w-full pl-8 pr-12 h-10">
                                <i class="fas fa-ruler-combined absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                                <span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm pointer-events-none">m¬≤</span>
                            </div>
                            <div class="relative">
                                <input type="number" id="propertyAnoConstruccion" name="propertyAnoConstruccion" placeholder="A√±o Construcci√≥n" min="1800" max="{{ now().year + 1 }}" class="form-input w-full pl-8 h-10">
                                <i class="fas fa-calendar-alt absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div class="relative">
                                <select id="propertyType" name="propertyType" class="form-input w-full pl-8 h-10">
                                    <option value="Residencial">Residencial</option> <option value="Comercial" selected>Comercial</option> <option value="Industrial">Industrial</option> <option value="Terreno">Terreno</option> <option value="Otro">Otro</option>
                                </select>
                                <i class="fas fa-tag absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <div class="relative">
                                <select id="propertyOwner" name="propertyOwner" required class="form-input w-full pl-8 h-10">
                                    <option value="">Seleccionar propietario *</option>
                                    {% for owner in propietarios %} <option value="{{ owner.id }}">{{ owner.nombre }}</option> {% endfor %}
                                </select>
                                <i class="fas fa-user-tie absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>
                        <div class="relative">
                            <textarea id="propertyDescription" name="propertyDescription" rows="3" placeholder="Descripci√≥n adicional..." class="form-input w-full pl-8 pt-3"></textarea>
                            <i class="fas fa-align-left absolute left-2.5 top-3 text-gray-400"></i>
                        </div>
                        <div id="propertyConstructionTableContainer" class="md:col-span-2 mt-3 hidden">
                             <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Detalle de Construcciones (Catastro):</h5>
                             <div class="overflow-x-auto border dark:border-gray-600 rounded-md max-h-40 bg-gray-50 dark:bg-gray-700/30">
                                 <table class="min-w-full text-xs">
                                     <thead class="bg-gray-100 dark:bg-gray-700"><tr class="text-left"><th class="p-1">Uso</th><th class="p-1 text-center">Esc.</th><th class="p-1 text-center">Pl.</th><th class="p-1 text-center">Pta.</th><th class="p-1 text-right">Sup. m¬≤</th></tr></thead>
                                     <tbody id="propertyConstructionTableBody" class="divide-y dark:divide-gray-600"></tbody>
                                 </table>
                             </div>
                        </div>
                        <div class="relative">
                            <label for="propertyStatus" class="sr-only">Estado Inicial</label>
                            <select id="propertyStatus" name="propertyStatus" class="form-input w-full pl-8 h-10"> <option value="vacia" selected>Vac√≠a</option> <option value="ocupada">Ocupada</option> <option value="mantenimiento">Mantenimiento</option> </select>
                            <i class="fas fa-traffic-light absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-900/50 px-6 py-4 flex justify-end space-x-2 border-t dark:border-gray-700">
                    <button type="button" onclick="closeModal('createPropertyModal')" class="px-4 py-2 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 border">Cancelar</button>
                    <button type="submit" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700">Guardar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal: Editar Propiedad -->
<div id="editPropertyModal" class="fixed inset-0 overflow-y-auto hidden z-50" role="dialog" aria-labelledby="edit-property-modal-title" aria-modal="true">
    <div class="flex items-end justify-center min-h-screen px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">‚Äã</span>
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-xl overflow-hidden shadow-2xl transform transition-all sm:my-8 sm:align-middle sm:max-w-3xl w-full modal-content">
             <form id="editPropertyForm" action="" method="POST" novalidate>
                {{ csrf_form.csrf_token }}
                 <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4">
                     <div class="flex items-center justify-between">
                         <h3 id="edit-property-modal-title" class="text-xl font-semibold text-white flex items-center"><i class="fas fa-edit mr-3"></i>Editar Propiedad</h3>
                         <button type="button" onclick="closeModal('editPropertyModal')" class="text-white/80 hover:text-white focus:outline-none p-1"><i class="fas fa-times text-xl"></i></button>
                     </div>
                 </div>
                 <div class="px-6 py-4 max-h-[calc(100vh-200px)] overflow-y-auto modal-body">
                     <div class="space-y-3">
                        <div class="mb-4 p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg border border-blue-200 dark:border-blue-800">
                            <h4 class="text-sm font-medium text-blue-800 dark:text-blue-200 mb-2">Actualizar desde Catastro</h4>
                            <div class="flex items-stretch">
                                <div class="relative flex-1">
                                    <input type="text" id="editCatastroSearchRef" placeholder="Ref. Catastral (actual o nueva)" maxlength="20" class="form-input w-full pl-8 pr-3 py-2 text-sm rounded-l-lg">
                                    <i class="fas fa-search absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                                </div>
                                <button type="button" onclick="fetchCatastroData('editProperty')" class="bg-gradient-to-r from-orange-500 to-red-500 hover:from-orange-600 hover:to-red-600 text-white px-4 py-2 rounded-r-lg text-sm">
                                    <i class="fas fa-sync-alt mr-1"></i><span class="hidden sm:inline">Actualizar</span>
                                </button>
                            </div>
                            <div id="editCatastroLookupStatus" class="text-xs mt-1 min-h-[1.2em]"></div>
                        </div>
                        <div class="relative">
                            <input type="text" id="editPropertyAddress" name="editPropertyAddress" required placeholder="Direcci√≥n *" class="form-input w-full pl-8 h-10">
                            <i class="fas fa-map-marker-alt absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <div class="relative sm:col-span-2"><input type="text" id="editPropertyCity" name="editPropertyCity" placeholder="Ciudad" class="form-input w-full pl-8 h-10"><i class="fas fa-city absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                            <div class="relative"><input type="text" id="editPropertyCP" name="editPropertyCP" placeholder="C.P." class="form-input w-full pl-8 h-10"><i class="fas fa-mail-bulk absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div class="relative"><input type="text" id="editPropertyRefCatastral" name="editPropertyRefCatastral" placeholder="Ref. Catastral" maxlength="20" class="form-input w-full pl-8 h-10"><i class="fas fa-barcode absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                            <div class="relative"><input type="text" id="editPropertyNumeroLocal" name="editPropertyNumeroLocal" placeholder="N¬∫ Local/Piso/Pta." maxlength="50" class="form-input w-full pl-8 h-10"><i class="fas fa-door-open absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div class="relative">
                                <input type="number" id="editPropertySuperficie" name="editPropertySuperficie" placeholder="Superficie (m¬≤)" min="0" class="form-input w-full pl-8 pr-12 h-10">
                                <i class="fas fa-ruler-combined absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i><span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm pointer-events-none">m¬≤</span>
                            </div>
                            <div class="relative">
                                <input type="number" id="editPropertyAnoConstruccion" name="editPropertyAnoConstruccion" placeholder="A√±o Construcci√≥n" min="1800" max="{{ now().year +1 }}" class="form-input w-full pl-8 pr-12 h-10">
                                <i class="fas fa-calendar-alt absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i><span class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-xs pointer-events-none">A√±o</span>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <div class="relative"><select id="editPropertyType" name="editPropertyType" class="form-input w-full pl-8 h-10"><option value="Residencial">Residencial</option><option value="Comercial">Comercial</option><option value="Industrial">Industrial</option><option value="Terreno">Terreno</option><option value="Otro">Otro</option></select><i class="fas fa-tag absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                            <div class="relative"><select id="editPropertyOwner" name="editPropertyOwner" required class="form-input w-full pl-8 h-10"><option value="">Propietario *</option>{% for o in propietarios %}<option value="{{o.id}}">{{o.nombre}}</option>{% endfor %}</select><i class="fas fa-user-tie absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                        </div>
                        <div class="relative md:col-span-2"><textarea id="editPropertyDescription" name="editPropertyDescription" rows="3" placeholder="Descripci√≥n adicional..." class="form-input w-full pl-8 pt-3"></textarea><i class="fas fa-align-left absolute left-2.5 top-3 text-gray-400"></i></div>
                        <div id="editPropertyConstructionTableContainer" class="md:col-span-2 mt-3 hidden">
                             <h5 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Detalle de Construcciones (Catastro):</h5>
                             <div class="overflow-x-auto border dark:border-gray-600 rounded-md max-h-40 bg-gray-50 dark:bg-gray-700/30">
                                 <table class="min-w-full text-xs"><thead class="bg-gray-100 dark:bg-gray-700"><tr class="text-left"><th class="p-1">Uso</th><th class="p-1 text-center">Esc.</th><th class="p-1 text-center">Pl.</th><th class="p-1 text-center">Pta.</th><th class="p-1 text-right">Sup. m¬≤</th></tr></thead><tbody id="editPropertyConstructionTableBody" class="divide-y dark:divide-gray-600"></tbody></table>
                             </div>
                        </div>
                        <div class="relative md:col-span-2"><select id="editPropertyStatus" name="editPropertyStatus" class="form-input w-full pl-8 h-10"><option value="vacia">Vac√≠a</option><option value="ocupada">Ocupada</option><option value="mantenimiento">Mantenimiento</option></select><i class="fas fa-traffic-light absolute left-2.5 top-1/2 transform -translate-y-1/2 text-gray-400"></i></div>
                     </div>
                 </div>
                 <div class="bg-gray-50 dark:bg-gray-900/50 px-6 py-4 flex justify-end space-x-2 border-t dark:border-gray-700">
                     <button type="button" onclick="closeModal('editPropertyModal')" class="px-4 py-2 rounded-lg bg-white dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 border">Cancelar</button>
                     <button type="submit" class="px-4 py-2 rounded-lg bg-gradient-to-r from-purple-600 to-indigo-600 text-white hover:from-purple-700 hover:to-indigo-700">Guardar Cambios</button>
                 </div>
             </form>
        </div>
    </div>
</div>

<!-- Modal: Confirmar Eliminaci√≥n -->
<div id="deletePropertyModal" class="fixed inset-0 overflow-y-auto hidden z-50">
     <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
        <div class="fixed inset-0 bg-gray-900/50 backdrop-blur-sm transition-opacity" aria-hidden="true"></div>
        <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">‚Äã</span>
        
        <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 sm:mx-0 sm:h-10 sm:w-10">
                        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400"></i>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Eliminar propiedad</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                ¬øEst√°s seguro de que deseas eliminar esta propiedad? Si tiene contratos o facturas asociados, no podr√° ser eliminada. Esta acci√≥n no se puede deshacer.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                 <button type="button" class="confirm-delete-button w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm">
                    <i class="fas fa-trash mr-2"></i>
                    Eliminar
                 </button>
                 <button type="button" onclick="closeModal('deletePropertyModal')" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-800 text-base font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 focus:outline-none sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
                    Cancelar
                 </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Variables globales para la b√∫squeda
    let totalProperties = 0;
    let visibleProperties = 0;

    // Funci√≥n helper para Title Case
    function toTitleCase(str) {
        if (!str) return "";
        return str.toLowerCase().split(' ').map(function (word) {
            return (word.charAt(0).toUpperCase() + word.slice(1));
        }).join(' ');
    }

    function showCreatePropertyModal() {
        try {
            const form = document.getElementById('createPropertyForm');
            if (form) {
                form.reset();
                document.getElementById('propertyType').value = 'Comercial'; // Default
                document.getElementById('propertyStatus').value = 'vacia'; // Default
            }
            const statusDiv = document.getElementById('catastroLookupStatus');
            if(statusDiv) statusDiv.innerHTML = '';
            const constructionTableContainer = document.getElementById('propertyConstructionTableContainer');
            if (constructionTableContainer) constructionTableContainer.classList.add('hidden');
            const constructionTableBody = document.getElementById('propertyConstructionTableBody');
            if (constructionTableBody) constructionTableBody.innerHTML = '';
            
        } catch(e) { console.error("Error reseteando form crear propiedad:", e); }
        showModal('createPropertyModal');
    }

    function editProperty(buttonElement) {
        try {
            const propertyRow = buttonElement.closest('tr.property-row');
            if (!propertyRow) { console.error("Fila de propiedad no encontrada."); return; }
            const propData = propertyRow.dataset;
            const propId = propData.id;
            if (!propId) { console.error("ID de propiedad no encontrado."); return; }

            document.getElementById('editPropertyAddress').value = propData.direccion || '';
            document.getElementById('editPropertyCity').value = propData.ciudad || '';
            document.getElementById('editPropertyCP').value = propData.cp || '';
            document.getElementById('editPropertyRefCatastral').value = propData.refCatastral || '';
            document.getElementById('editCatastroSearchRef').value = propData.refCatastral || ''; // Para la b√∫squeda en edici√≥n
            document.getElementById('editPropertyNumeroLocal').value = propData.numeroLocal || '';
            document.getElementById('editPropertySuperficie').value = propData.superficie || '';
            document.getElementById('editPropertyAnoConstruccion').value = propData.anoConstruccion || '';
            document.getElementById('editPropertyType').value = propData.tipo || 'Residencial';
            document.getElementById('editPropertyDescription').value = propData.descripcion || '';
            document.getElementById('editPropertyStatus').value = propData.estado || 'vacia';
            document.getElementById('editPropertyOwner').value = propData.propietarioId || '';

            const editForm = document.getElementById('editPropertyForm');
            if (editForm) {
                 editForm.action = `{{ url_for('propiedades_bp.edit_propiedad', id=0) }}`.replace('0', propId);
            } else { console.error("Formulario 'editPropertyForm' no encontrado."); return; }
            
            // Limpiar info de catastro y tabla de construcciones del modal de edici√≥n
            const editStatusDiv = document.getElementById('editCatastroLookupStatus');
            if(editStatusDiv) editStatusDiv.innerHTML = '';
            const editConstructionTableContainer = document.getElementById('editPropertyConstructionTableContainer');
            if (editConstructionTableContainer) editConstructionTableContainer.classList.add('hidden');
            const editConstructionTableBody = document.getElementById('editPropertyConstructionTableBody');
            if (editConstructionTableBody) editConstructionTableBody.innerHTML = '';

            showModal('editPropertyModal');
        } catch (e) { console.error("Error en editProperty:", e); alert("Ocurri√≥ un error al preparar la edici√≥n."); }
    }

    function deleteProperty(id) {
        try {
            const modal = document.getElementById('deletePropertyModal');
            if (!modal) { console.error("Modal 'deletePropertyModal' no encontrado"); return; }
            const confirmBtn = modal.querySelector('.confirm-delete-button');
            if (!confirmBtn) { console.error("Bot√≥n de confirmaci√≥n no encontrado"); return; }
            const csrfTokenValue = document.querySelector('#createPropertyForm input[name="csrf_token"]')?.value || 
                                   document.querySelector('#editPropertyForm input[name="csrf_token"]')?.value ||
                                   document.querySelector('meta[name="csrf-token"]')?.content || '';
            if (!csrfTokenValue) {
                console.error("Token CSRF no encontrado para deleteProperty.");
                alert("Error de seguridad. No se puede eliminar.");
                return;
            }
            confirmBtn.onclick = function() {
                if (typeof confirmDeleteWithToken === 'function') {
                    confirmDeleteWithToken('deletePropertyModal', `{{ url_for('propiedades_bp.delete_propiedad', id=0) }}`.replace('0', id), csrfTokenValue);
                } else { 
                    closeModal('deletePropertyModal');
                    const form = document.createElement('form'); form.method = 'POST'; form.action = `{{ url_for('propiedades_bp.delete_propiedad', id=0) }}`.replace('0', id);
                    const csrfInput = document.createElement('input'); csrfInput.type = 'hidden'; csrfInput.name = 'csrf_token'; csrfInput.value = csrfTokenValue;
                    form.appendChild(csrfInput); document.body.appendChild(form); form.submit();
                }
            };
            showModal('deletePropertyModal');
        } catch (e) { console.error("Error en deleteProperty:", e); }
    }

    function updateSearchCounter() {
        const resultsCount = document.getElementById('resultsCount');
        const totalCount = document.getElementById('totalCount');
        if (resultsCount) resultsCount.textContent = visibleProperties;
        if (totalCount) totalCount.textContent = totalProperties;
    }

    function searchProperties() {
        try {
            const searchTerm = document.getElementById('propertySearch').value.toLowerCase().trim();
            const rows = document.querySelectorAll('#propertiesTable tr.property-row');
            
            visibleProperties = 0;
            totalProperties = rows.length;
            
            rows.forEach(row => {
                // B√∫squeda mejorada que incluye todos los datos de la propiedad
                const rowData = row.dataset;
                const searchableText = [
                    rowData.direccion || '',
                    rowData.ciudad || '',
                    rowData.cp || '',
                    rowData.refCatastral || '',
                    rowData.numeroLocal || '',
                    rowData.superficie || '',
                    rowData.anoConstruccion || '',
                    rowData.tipo || '',
                    rowData.propietarioNombre || '', // Nuevo: nombre del propietario
                    rowData.descripcion || '',
                    rowData.estado || ''
                ].join(' ').toLowerCase();

                const isVisible = searchableText.includes(searchTerm) || searchTerm === '';
                row.style.display = isVisible ? '' : 'none';
                
                if (isVisible) {
                    visibleProperties++;
                }
                
                // Efecto visual de highlight en coincidencias
                if (searchTerm && isVisible && searchTerm.length > 0) {
                    row.classList.add('bg-yellow-50', 'dark:bg-yellow-900/20');
                } else {
                    row.classList.remove('bg-yellow-50', 'dark:bg-yellow-900/20');
                }
            });
            
            updateSearchCounter();
            
            // Mostrar mensaje si no hay resultados
            showNoResultsMessage(visibleProperties === 0 && searchTerm !== '');
            
        } catch (e) { 
            console.error("Error en searchProperties:", e); 
        }
    }

    function showNoResultsMessage(show) {
        let noResultsRow = document.getElementById('noResultsRow');
        
        if (show) {
            if (!noResultsRow) {
                const tbody = document.getElementById('propertiesTable');
                noResultsRow = document.createElement('tr');
                noResultsRow.id = 'noResultsRow';
                noResultsRow.className = 'bg-gray-50 dark:bg-gray-700';
                noResultsRow.innerHTML = `
                    <td colspan="10" class="px-6 py-8 text-center">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-search text-gray-400 text-3xl mb-2"></i>
                            <p class="text-gray-500 dark:text-gray-400 text-sm">
                                No se encontraron propiedades que coincidan con tu b√∫squeda
                            </p>
                            <button onclick="clearSearch()" class="mt-2 text-blue-600 hover:text-blue-800 text-sm underline">
                                Limpiar b√∫squeda
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(noResultsRow);
            }
            noResultsRow.style.display = '';
        } else if (noResultsRow) {
            noResultsRow.style.display = 'none';
        }
    }

    function clearSearch() {
        const searchInput = document.getElementById('propertySearch');
        if (searchInput) {
            searchInput.value = '';
            searchProperties();
            searchInput.focus();
        }
    }


    function makePropertyRowsClickable() {
        document.querySelectorAll('#propertiesTable tr.property-row').forEach(row => {
            const newRow = row.cloneNode(true);
            row.parentNode.replaceChild(newRow, row);

            newRow.style.cursor = 'pointer';
            newRow.addEventListener('click', function(event) {
                if (event.target.closest('button, a')) {
                    return;
                }
                const firstCellWithPotentialButton = this.querySelector('td:last-child button');
                if (typeof editProperty === "function") {
                     if (firstCellWithPotentialButton) {
                        editProperty(firstCellWithPotentialButton); // Asume que editProperty espera el bot√≥n
                     } else {
                        // Alternativa: editProperty(this); si la funci√≥n se adapta
                        console.warn("No se encontr√≥ bot√≥n para pasar a editProperty.");
                        editProperty(this); // Prueba pasando la fila directamente
                     }
                }
            });
        });
    }


    // Inicializar contador al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        const rows = document.querySelectorAll('#propertiesTable tr.property-row');
        totalProperties = rows.length;
        visibleProperties = rows.length;
        updateSearchCounter();
        makePropertyRowsClickable();		
    });

    async function fetchCatastroData(modalPrefix = 'property') {
        const refCatSearchInput = document.getElementById(modalPrefix === 'property' ? 'catastroSearchRef' : 'editCatastroSearchRef');
        const statusDiv = document.getElementById(modalPrefix === 'property' ? 'catastroLookupStatus' : 'editCatastroLookupStatus');
        
        const addressInput = document.getElementById(modalPrefix + 'Address');
        const cityInput = document.getElementById(modalPrefix + 'City');
        const cpInput = document.getElementById(modalPrefix + 'PostalCode');
        const actualRefCatInput = document.getElementById(modalPrefix + 'RefCatastral');
        const tipoPropiedadSelect = document.getElementById(modalPrefix + 'Type');
        const superficieInput = document.getElementById(modalPrefix + 'Superficie');
        const anoConstruccionInput = document.getElementById(modalPrefix + 'AnoConstruccion');
        const descripcionInput = document.getElementById(modalPrefix + 'Description');
        const constructionTableContainer = document.getElementById(modalPrefix + 'ConstructionTableContainer');
        const constructionTableBody = document.getElementById(modalPrefix + 'ConstructionTableBody');

        // Limpiar campos que se van a rellenar desde Catastro, excepto si es el modal de edici√≥n
        // y el campo de descripci√≥n (queremos a√±adir, no reemplazar por defecto)
        if (addressInput) addressInput.value = '';
        if (cityInput) cityInput.value = '';
        if (cpInput) cpInput.value = '';
        if (tipoPropiedadSelect) tipoPropiedadSelect.value = 'Comercial';
        if (superficieInput) superficieInput.value = '';
        if (anoConstruccionInput) anoConstruccionInput.value = '';
        
        if (constructionTableContainer) constructionTableContainer.classList.add('hidden');
        if (constructionTableBody) constructionTableBody.innerHTML = '';


        if (!refCatSearchInput || !refCatSearchInput.value.trim()) {
            if (statusDiv) statusDiv.innerHTML = '<span class="text-yellow-600 dark:text-yellow-400">Introduce una Referencia Catastral.</span>';
            if (refCatSearchInput) refCatSearchInput.focus(); return;
        }
        const refCat = refCatSearchInput.value.trim().toUpperCase();
        if (refCat.length < 14 || refCat.length > 20) {
            if (statusDiv) statusDiv.innerHTML = '<span class="text-yellow-600 dark:text-yellow-400">La Referencia Catastral debe tener entre 14 y 20 caracteres.</span>';
            if (refCatSearchInput) refCatSearchInput.focus(); return;
        }
        if (statusDiv) statusDiv.innerHTML = '<span class="text-blue-600 dark:text-blue-400"><i class="fas fa-spinner fa-spin mr-1"></i>Buscando en Catastro...</span>';

        try {
            const response = await fetch(`https://ovc.catastro.meh.es/OVCServWeb/OVCWcfCallejero/COVCCallejero.svc/json/Consulta_DNPRC?RefCat=${encodeURIComponent(refCat)}`);
            
            if (!response.ok) { 
                let errorText = `Error del servidor Catastro: ${response.status} ${response.statusText}`;
                try {
                    const errorData = await response.text();
                    if (errorData.toLowerCase().includes("referencia catastral incorrecta") || errorData.toLowerCase().includes("no existe")) {
                        errorText = "Referencia Catastral no encontrada o incorrecta.";
                    } else {
                        const jsonData = JSON.parse(errorData); 
                        if (jsonData?.consulta_dnprcResult?.control?.deserror) {
                            errorText = `Error Catastro: ${jsonData.consulta_dnprcResult.control.deserror}`;
                        }
                    }
                } catch (e) { /* El error original de red es suficiente */ }
                throw new Error(errorText);
            }
            
            const result = await response.json();
            if (statusDiv) statusDiv.innerHTML = ''; 
            console.log("Respuesta Catastro Completa:", JSON.stringify(result, null, 2));
            const consulta = result.consulta_dnprcResult || result.consulta_dnprc;

            if (consulta && consulta.bico && consulta.bico.bi && consulta.bico.bi.dt) {
                const bi = consulta.bico.bi;
                const dt = bi.dt;
                const debi = bi.debi;
                const lcons = consulta.bico.lcons;

                let direccionCatastro = "";
                let datosInteriorCatastro = "";
                if (dt.locs?.lous?.lourb?.dir) {
                    const dir = dt.locs.lous.lourb.dir;
                    const tipoVia = dir.tv ? toTitleCase(dir.tv.trim()) : ""; 
                    const nombreVia = dir.nv ? toTitleCase(dir.nv.trim()) : ""; 
                    if (tipoVia) direccionCatastro += tipoVia;
                    if (nombreVia) direccionCatastro = (direccionCatastro ? direccionCatastro + " " : "") + nombreVia;
                    const numeroPortal = dir.pnp ? dir.pnp.trim().toUpperCase() : null;
                    const letraPortal = dir.plp ? dir.plp.trim().toUpperCase() : null;
                    const bloque = dir.bq ? dir.bq.trim().toUpperCase() : null;
                    let parteNumero = "";
                    if (numeroPortal) { parteNumero += numeroPortal; if (letraPortal) parteNumero += letraPortal; }
                    if (bloque) parteNumero = (parteNumero ? parteNumero + " " : "") + `BLQ. ${bloque}`;
                    if (parteNumero) direccionCatastro = (direccionCatastro ? direccionCatastro + ", " : "") + parteNumero;
                }
                if (dt.locs?.lous?.lourb?.loint) {
                    const loint = dt.locs.lous.lourb.loint;
                    if (loint.es?.trim()) datosInteriorCatastro += `Esc. ${loint.es.trim().toUpperCase()} `;
                    if (loint.pl?.trim()) datosInteriorCatastro += `Pl. ${loint.pl.trim().toUpperCase()} `; 
                    if (loint.pu?.trim()) datosInteriorCatastro += `Pta. ${loint.pu.trim().toUpperCase()} `;
                    datosInteriorCatastro = datosInteriorCatastro.trim();
                }
                if (datosInteriorCatastro) direccionCatastro = (direccionCatastro ? direccionCatastro + ", " : "") + datosInteriorCatastro;

                if (addressInput) addressInput.value = direccionCatastro.replace(/\.$/, "").trim();
                if (cityInput && dt.nm) cityInput.value = toTitleCase(dt.nm);
                if (cpInput && dt.locs?.lous?.lourb?.dp) cpInput.value = dt.locs.lous.lourb.dp;
                if (actualRefCatInput) actualRefCatInput.value = refCat;

                if (superficieInput && debi?.sfc) superficieInput.value = debi.sfc;
                if (anoConstruccionInput && debi?.ant) anoConstruccionInput.value = debi.ant;
                
                if (tipoPropiedadSelect && debi?.luso) {
                    const usoCatastro = debi.luso.toLowerCase();
                    if (usoCatastro.includes("comercial") || usoCatastro.includes("oficina")) tipoPropiedadSelect.value = "Comercial";
                    else if (usoCatastro.includes("industrial") || usoCatastro.includes("almac√©n")) tipoPropiedadSelect.value = "Industrial";
                    else if (usoCatastro.includes("residencial") || usoCatastro.includes("vivienda")) tipoPropiedadSelect.value = "Residencial";
                    else if (usoCatastro.includes("suelo") || usoCatastro.includes("terreno")) tipoPropiedadSelect.value = "Terreno";
                    else tipoPropiedadSelect.value = "Otro";
                }

                if (lcons && Array.isArray(lcons) && lcons.length > 0 && constructionTableBody && constructionTableContainer) {
                    constructionTableBody.innerHTML = ''; 
                    lcons.forEach(cons => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50 dark:hover:bg-gray-600';
                        const uso = cons.lcd || "-";
                        const es = cons.dt?.lourb?.loint?.es || "-";
                        const pl = cons.dt?.lourb?.loint?.pl || "-";
                        const pu = cons.dt?.lourb?.loint?.pu || "-";
                        const stl = cons.dfcons?.stl ? `${cons.dfcons.stl} m¬≤` : "-";
                        row.innerHTML = `
                            <td class="px-2 py-1 text-sm text-gray-900 dark:text-gray-100">${uso}</td>
                            <td class="px-2 py-1 text-sm text-center text-gray-700 dark:text-gray-300">${es}</td>
                            <td class="px-2 py-1 text-sm text-center text-gray-700 dark:text-gray-300">${pl}</td>
                            <td class="px-2 py-1 text-sm text-center text-gray-700 dark:text-gray-300">${pu}</td>
                            <td class="px-2 py-1 text-sm text-right text-gray-700 dark:text-gray-300 font-mono">${stl}</td>`;
                        constructionTableBody.appendChild(row);
                    });
                    constructionTableContainer.classList.remove('hidden');
                } else if (constructionTableContainer) {
                    constructionTableContainer.classList.add('hidden');
                }
                if (statusDiv) statusDiv.innerHTML = '<span class="text-green-600 dark:text-green-400"><i class="fas fa-check-circle mr-1"></i>Datos catastrales cargados.</span>';
            } else if (consulta?.control?.cuerr > 0) {
                if (statusDiv) statusDiv.innerHTML = `<span class="text-red-600 dark:text-red-400">${consulta.control.deserror || "Error Catastro."}</span>`;
            } else {
                if (statusDiv) statusDiv.innerHTML = '<span class="text-red-600 dark:text-red-400">Respuesta inesperada o sin datos del Catastro.</span>';
            }
        } catch (error) {
            console.error('Error fetching Catastro data:', error);
            if (statusDiv) statusDiv.innerHTML = `<span class="text-red-600 dark:text-red-400">Error: ${error.message}.</span>`;
        }
    }
    
    console.log('üè¢ Sistema de Propiedades cargado correctamente');
</script>
{% endblock %}